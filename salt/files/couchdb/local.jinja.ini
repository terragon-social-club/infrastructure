{% set couch_node_count = salt['mine.get']('roles:couchdb', 'network.interface_ip', tgt_type='grain').items()|length %}
{% set couchdb_nodes = salt['mine.get']('roles:couchdb', 'network.interface_ip', tgt_type='grain').items() %}
{% if grains['id'] != 'couchdb-a' %}
{% set couch_uuids = salt['mine.get']('roles:couchdb', 'uuid', tgt_type='grain') %}
{% if couch_uuids['couchdb-a'] %}
[couchdb]
uuid = {{ couch_uuids['couchdb-a'] }}
{% endif %}
{% endif %}

[httpd]
enable_cors = true

[chttpd]
bind_address = {{ salt['network.interface_ip']('vtnet1') }}

[couch_httpd_auth]
allow_persistent_cookies = true
auth_cache_size = 200
iterations = 10
min_iterations = 2
max_iterations = 10
require_valid_user = true
users_db_public = false
timeout = 600
secret = {{ grains['couch_user'] + grains['couch_pass'] }}

[cors]
origins = *
credentials = true

[cluster]
q=1 # Shard count
n={{ couch_node_count }} # Replica count
seedlist={% for couchdb_node_private_address in couchdb_nodes %}{{ couchdb_node_private_address[0] }}@{{ couchdb_node_private_address[1] }}{{ "," if not loop.last }}{% endfor %}

# Security Document - 0.1
[admins]
{{ grains['couch_user'] }} = {{ grains['couch_pass'] }}
