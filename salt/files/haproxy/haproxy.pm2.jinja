# Simple configuration for an HTTP proxy listening on port 80 on all
    # interfaces and forwarding requests to a single backend "servers" with a
    # single server "server1" listening on 127.0.0.1:8000
    global
        daemon
        maxconn 1000

    defaults
        mode http
        timeout connect 5000ms
        timeout client 50000ms
        timeout server 50000ms

    frontend http-in
        bind *:80
        bind *:443 ssl crt /usr/local/etc/letsencrypt/keys/0013_key-certbot.pem
        redirect scheme https if !{ ssl_fc }
        default_backend servers

    backend servers
        mode http
        balance roundrobin
        {% for address in salt['mine.get']('roles:pm2-nodejs-api', 'network.interface_ip', tgt_type='grain').items() %}
        server express{{ loop.index }} {{ address[1] }}:3000 check
        {% endfor %}
