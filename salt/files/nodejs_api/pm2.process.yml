{% set couch_addresses = salt['mine.get']('roles:couchdb', 'network.interface_ip', tgt_type='grain').items() %}

apps:
  - script: /usr/local/lib/node_modules/@terragon/api/dist/server.js
    instances: max
    exec_mode: cluster
    name: terragon
    env:
      API_BIND_IP: {{ salt['network.interface_ip']('vtnet1') }}
      COUCH_ADDRESSES: [{% for address in couch_addresses %}"{{ address[1] }}"{% if loop.index != couch_addresses|length %},{% endif %}{% endfor %}]
      COUCH_USER: {{ grains['couch_user'] }}
      COUCH_PASS: {{ grains['couch_pass'] }}
      STRIPE_KEY: {{ grains['stripe_api_key'] }}
