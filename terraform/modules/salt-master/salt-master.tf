variable "name" { }
variable "domain_id" { }

variable "keys" {
  type = list
}

variable "region" {
  default = "nyc1"
}

variable "image" {
  default = ""
}

variable "size" {
  default = "s-1vcpu-1gb"
}

variable "disk_size" {
  default = 0
}

variable "listen_all_interfaces" {
  default = false
}

variable "autogenerated_ssh_private_key" { }
variable "tld" { }

resource "digitalocean_droplet" "salt_master" {
  private_networking = true
  backups = false
  region = var.region
  image = var.image
  name = "${var.name}.private.${var.tld}"
  size = var.size
  ssh_keys = var.keys
  ipv6 = false
  resize_disk = false
}

resource "digitalocean_volume" "storage" {
  count = var.disk_size > 0 ? 1 : 0
  region = var.region
  name = var.name
  size = var.disk_size
  initial_filesystem_type = "ext4" // salt will reformat to zfs
}

resource "digitalocean_volume_attachment" "storage" {
  count = length(digitalocean_volume.storage)
  droplet_id = digitalocean_droplet.salt_master.id
  volume_id  = digitalocean_volume.storage[0].id
}

resource "digitalocean_record" "salt_master" {
  domain = var.domain_id
  type = "A"
  name = var.name
  ttl = 31
  value = digitalocean_droplet.salt_master.ipv4_address
}

resource "digitalocean_record" "salt_master_private" {
  domain = var.domain_id
  type = "A"
  name = "${var.name}.private"
  ttl = 31
  value = digitalocean_droplet.salt_master.ipv4_address_private
}

resource "digitalocean_firewall" "ssh_public_access" {
  name="Public-To-Master"
  droplet_ids = [digitalocean_droplet.salt_master.id]
  
  inbound_rule {
    protocol = "tcp"
    port_range = "22"
    source_addresses = ["0.0.0.0/0"]
  }
  
}

resource "digitalocean_firewall" "all_outbound" {
  name="All-Salt-Master-Outbound"
  droplet_ids = [digitalocean_droplet.salt_master.id]

  outbound_rule {
    protocol = "udp"
    port_range = "1-65535"
    destination_addresses = ["0.0.0.0/0"]
  }
  
  outbound_rule {
    protocol = "icmp"
    destination_addresses = ["0.0.0.0/0"]
  }
  
  outbound_rule {
    protocol = "tcp"
    port_range = "1-65535"
    destination_addresses = ["0.0.0.0/0"]
  }
  
}

resource "tls_private_key" "master_key" {
  algorithm = "RSA"
}

resource "digitalocean_ssh_key" "salt_master" {
  name = "Salt Master"
  public_key = tls_private_key.master_key.public_key_openssh
}

resource "null_resource" "master_prep" {
  depends_on = [
    digitalocean_firewall.ssh_public_access,
    digitalocean_firewall.all_outbound
  ]

  triggers = {
    ids = digitalocean_droplet.salt_master.id
  }
  
  connection {
    host = digitalocean_droplet.salt_master.ipv4_address
    private_key = var.autogenerated_ssh_private_key
    user = "root"
    type = "ssh"
    timeout = "30m"
  }
  
  provisioner "remote-exec" {
    inline = [
      "env ASSUME_ALWAYS_YES=YES pkg install htop",
      "env ASSUME_ALWAYS_YES=YES pkg install git",
      "env ASSUME_ALWAYS_YES=YES pkg install devel/py-gitpython"
    ]
    
  }

  provisioner "remote-exec" {
    inline = [
      "pkg install -y ca_root_nss py37-salt",
      "mkdir -p /usr/local/etc/salt/master.d",
      "mkdir -p /usr/local/etc/salt/minion.d",
    ]
    
  }

  provisioner "file" {
    content = data.template_file.master_address.rendered
    destination = "/usr/local/etc/salt/minion.d/99-master-address.conf"
  }

  provisioner "file" {
    content = data.template_file.master_config.rendered
    destination = "/usr/local/etc/salt/master.d/99-master-config.conf"
  }

  provisioner "file" {
    source = "${path.module}/../98-minion-config.conf"
    destination = "/usr/local/etc/salt/minion.d/98-minion-config.conf"
  }

  provisioner "file" {
    content = data.template_file.minion_id.rendered
    destination = "/usr/local/etc/salt/minion_id"
  }

  provisioner "remote-exec" {
    inline = [
      "salt-key --gen-keys=${var.name}",
      "mkdir -p /usr/local/etc/salt/pki/master/minions",
      "mkdir -p /usr/local/etc/salt/pki/minion",
      "cp ${var.name}.pub /usr/local/etc/salt/pki/master/minions/${var.name}",
      "mv ${var.name}.pub /usr/local/etc/salt/pki/minion/minion.pub",
      "mv ${var.name}.pem /usr/local/etc/salt/pki/minion/minion.pem"
    ]
    
  }

  provisioner "file" {
    content = data.template_file.grains.rendered
    destination = "/usr/local/etc/salt/grains"
  }

  provisioner "file" {
    content = tls_private_key.master_key.public_key_openssh
    destination = "/root/.ssh/id_rsa.pub"
  }

  provisioner "file" {
    content = tls_private_key.master_key.private_key_pem
    destination = "/root/.ssh/id_rsa"
  }

  provisioner "file" {
    content = data.template_file.minion_id.rendered
    destination = "/usr/local/etc/salt/minion_id"
  }

  provisioner "remote-exec" {
    inline = [
      "service salt_master onestart",
      "service salt_minion onestart"
    ]
    
  }
  
}

data "template_file" "grains" {
  template = file("${path.module}/../grains.tpl")
  vars = {
    roles = var.disk_size > 0 ? "  - master\r\n  - public\r\n  - storage" : "  - master\r\n  - public"
    fqdn = "${var.name}.${var.tld}"
  }
  
}

data "template_file" "master_address" {
  template = file("${path.module}/../99-master-address.conf.tpl")
  vars = {
    master_ip = var.listen_all_interfaces ? "0.0.0.0" : digitalocean_droplet.salt_master.ipv4_address_private
  }
  
}

data "template_file" "minion_id" {
  template = file("${path.module}/../minion_id.tpl")
  vars = {
    minion_id = var.name
  }
  
}

data "template_file" "master_config" {
  template = file("${path.module}/../99-master-config.conf.tpl")
  vars = {
    private_ip = digitalocean_droplet.salt_master.ipv4_address_private
  }
  
}

output "private_ip_address" {
  value = digitalocean_droplet.salt_master.ipv4_address_private
}

output "public_ip_address" {
  value = digitalocean_droplet.salt_master.ipv4_address
}

output "fqdn" {
  value = digitalocean_record.salt_master.fqdn
}

output "ssh_fingerprint" {
  value = digitalocean_ssh_key.salt_master.fingerprint
}

output "droplet_id" {
  value = digitalocean_droplet.salt_master.id
}
